_format_version: "3.0"
_transform: true

services:
  - name: repairmybike-backend
    url: http://django-backend:8000
    plugins:
      - name: cors
        config:
          origins:
            - "*"
          methods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
          headers:
            - Accept
            - Accept-Version
            - Content-Length
            - Content-MD5
            - Content-Type
            - Date
            - Authorization
            - X-Auth-Token
          exposed_headers:
            - X-Auth-Token
            - X-API-Version
          credentials: true
          max_age: 3600
      - name: rate-limiting
        config:
          minute: 100
          hour: 1000
          day: 10000
          policy: local
      - name: request-size-limiting
        config:
          allowed_payload_size: 10
      - name: response-transformer
        config:
          add:
            headers:
              - "X-API-Version:1.0"
              - "X-Powered-By:Kong-Gateway"
              - "X-Service:RepairMyBike"

routes:
  - name: api-routes
    service: repairmybike-backend
    paths:
      - /api
    strip_path: false
    plugins:
      - name: key-auth
        config:
          key_names:
            - apikey
            - X-API-Key
          hide_credentials: true
      - name: request-transformer
        config:
          add:
            headers:
              - "X-Forwarded-Proto:https"
              - "X-Real-IP:$remote_addr"

  - name: admin-routes
    service: repairmybike-backend
    paths:
      - /admin
    strip_path: false
    plugins:
      - name: ip-restriction
        config:
          allow:
            - "127.0.0.1"
            - "10.0.0.0/8"
            - "172.16.0.0/12"
            - "192.168.0.0/16"
      - name: basic-auth
        config:
          hide_credentials: true

  - name: health-check
    service: repairmybike-backend
    paths:
      - /health
    strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 20
          policy: local

consumers:
  - username: flutter-app
    keyauth_credentials:
      - key: rmb-flutter-api-key-2024
  - username: mobile-app
    keyauth_credentials:
      - key: rmb-mobile-api-key-2024
  - username: web-app
    keyauth_credentials:
      - key: rmb-web-api-key-2024

plugins:
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true
  - name: file-log
    config:
      path: /tmp/kong-access.log
      reopen: true
  - name: request-id
    config:
      header_name: X-Request-ID
      generator: uuid
  - name: correlation-id
    config:
      header_name: X-Correlation-ID
      generator: uuid